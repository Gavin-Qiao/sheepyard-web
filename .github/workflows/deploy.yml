name: Production Deployment

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Execute Deployment Script via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ubuntu
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # Stop script on first error
            set -e

            # Navigate to the application directory
            cd ~/sheepyard-web
            
            # --- STEP 1: PREPARE BACKUP ---
            echo "üì¶ Creating temporary backup of server settings..."
            mkdir -p /tmp/sheepyard_backup
            
            # Backup .env (Secrets)
            if [ -f .env ]; then
              cp .env /tmp/sheepyard_backup/.env
            fi
            
            # Backup Caddyfile (Web Server Config)
            if [ -f config/caddy/Caddyfile ]; then
              cp config/caddy/Caddyfile /tmp/sheepyard_backup/Caddyfile
            fi

            # Backup Docker Settings (Orchestration Configs)
            if [ -f docker-compose.yml ]; then
              cp docker-compose.yml /tmp/sheepyard_backup/docker-compose.yml
            fi
            
            # --- STEP 2: BRUSH SERVER (Force Sync) ---
            echo "üßπ Brushing server to match Git repository..."
            git fetch --all
            # WARNING: This deletes ALL local changes/untracked files
            git reset --hard origin/main
            
            # --- STEP 3: RESTORE SETTINGS ---
            echo "‚ôªÔ∏è Restoring server settings..."
            
            # Restore .env
            if [ -f /tmp/sheepyard_backup/.env ]; then
              mv /tmp/sheepyard_backup/.env .env
            fi
            
            # Restore Caddyfile
            if [ -f /tmp/sheepyard_backup/Caddyfile ]; then
              # Ensure directory exists just in case
              mkdir -p config/caddy
              mv /tmp/sheepyard_backup/Caddyfile config/caddy/Caddyfile
            fi

            # Restore Docker Settings
            if [ -f /tmp/sheepyard_backup/docker-compose.yml ]; then
              mv /tmp/sheepyard_backup/docker-compose.yml docker-compose.yml
            fi
            
            if [ -f /tmp/sheepyard_backup/docker-compose.override.yml ]; then
              mv /tmp/sheepyard_backup/docker-compose.override.yml docker-compose.override.yml
            fi

            # --- STEP 4: CLEANUP BACKUP ---
            echo "üóëÔ∏è Deleting temporary backups..."
            rm -rf /tmp/sheepyard_backup

            # --- STEP 5: BUILD & DEPLOY ---
            echo "üöÄ Starting deployment..."
            docker compose up -d --build
            
            # Remove unused images to save space
            docker image prune -f
            
            echo "‚úÖ Deployment successful!"